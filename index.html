<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Narrative AI Business Analyst</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: rgba(255, 255, 255, 0.2);
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --text-color: #333;
        --border-radius: 20px;
        --transition: all 0.3s ease;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        color: var(--text-color);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border: 1px solid var(--glass-border);
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .header h1 {
        font-size: 2.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .connection-status {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 10px 15px;
        border: 1px solid #e0e0e0;
      }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s infinite;
      }

      .status-dot.offline {
        background: #dc3545;
      }

      .language-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 10px 15px;
        border: 1px solid #e0e0e0;
      }

      .language-selector select {
        border: none;
        background: transparent;
        font-size: 1rem;
        color: var(--text-color);
        outline: none;
        cursor: pointer;
      }

      .role-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .role-card {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid transparent;
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
      }

      .role-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .role-card.active {
        border-color: var(--primary-color);
        background: var(--primary-gradient);
        color: white;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .left-panel,
      .right-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
        padding: 30px;
        box-shadow: var(--shadow);
        border: 1px solid var(--glass-border);
      }

      .chat-container {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.5);
        scroll-behavior: smooth;
      }

      .message {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 15px;
        max-width: 85%;
        animation: fadeIn 0.3s ease;
        word-wrap: break-word;
        position: relative;
      }

      .message.user {
        background: var(--primary-gradient);
        color: white;
        margin-left: auto;
      }

      .message.ai {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e0e0e0;
      }

      .message.system {
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.3);
        color: #856404;
        text-align: center;
        max-width: 100%;
        margin: 10px 0;
      }

      .message.error {
        background: rgba(220, 53, 69, 0.1);
        border: 1px solid rgba(220, 53, 69, 0.3);
        color: #721c24;
        max-width: 100%;
      }

      .message-actions {
        position: absolute;
        top: 5px;
        right: 5px;
        display: none;
        gap: 5px;
      }

      .message:hover .message-actions {
        display: flex;
      }

      .action-btn {
        background: rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
        transition: var(--transition);
      }

      .action-btn:hover {
        background: rgba(0, 0, 0, 0.2);
        transform: scale(1.1);
      }

      .input-section {
        display: flex;
        gap: 10px;
        align-items: center;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 25px;
        padding: 5px;
        border: 1px solid #e0e0e0;
      }

      .chat-input {
        flex: 1;
        padding: 15px 20px;
        border: none;
        border-radius: 20px;
        font-size: 1rem;
        outline: none;
        background: transparent;
      }

      .file-upload-btn,
      .send-btn,
      .voice-btn,
      .speaker-btn {
        padding: 12px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 1rem;
        position: relative;
      }

      .file-upload-btn {
        background: rgba(102, 126, 234, 0.1);
        color: var(--primary-color);
      }

      .send-btn {
        background: var(--primary-gradient);
        color: white;
        padding: 12px 16px;
      }

      .send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .voice-btn,
      .speaker-btn {
        background: rgba(118, 75, 162, 0.1);
        color: var(--secondary-color);
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .chart-container {
        height: 300px;
        margin-bottom: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1),
          rgba(118, 75, 162, 0.1)
        );
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        transition: var(--transition);
      }

      .stat-card:hover {
        transform: translateY(-3px);
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 5px;
      }

      .insights-panel {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
      }

      .insight-card {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1),
          rgba(118, 75, 162, 0.1)
        );
        border-left: 4px solid var(--primary-color);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        transition: var(--transition);
      }

      .typing-indicator {
        display: none;
        padding: 15px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e0e0e0;
        border-radius: 15px;
        max-width: 85%;
        margin-bottom: 15px;
      }

      .typing-dots span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary-color);
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
      }

      .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }

      .audio-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--glass-bg);
        border-radius: 15px;
        padding: 15px;
        box-shadow: var(--shadow);
        display: none;
        align-items: center;
        gap: 10px;
        z-index: 1000;
      }

      .progress-bar {
        width: 100px;
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--primary-gradient);
        width: 0%;
        transition: width 0.1s ease;
      }

      .status-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--glass-bg);
        border-radius: 15px;
        padding: 10px 15px;
        box-shadow: var(--shadow);
        z-index: 1000;
        display: none;
      }

      .file-input {
        display: none;
      }

      /* Animations */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      @keyframes typing {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }
        
        .header h1 {
          font-size: 2rem;
        }
        
        .header-top {
          flex-direction: column;
          align-items: stretch;
        }
        
        .role-selector {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header Section -->
      <header class="header">
        <div class="header-top">
          <h1>📊 Narrative AI</h1>
          <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Connecting...</span>
          </div>
          <div class="language-selector">
            <span>🌐</span>
            <select id="languageSelect">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="it">Italian</option>
              <option value="pt">Portuguese</option>
              <option value="ru">Russian</option>
              <option value="zh">Chinese</option>
              <option value="ja">Japanese</option>
              <option value="ko">Korean</option>
              <option value="ar">Arabic</option>
              <option value="hi">Hindi</option>
            </select>
          </div>
        </div>
        
        <div class="role-selector">
          <div class="role-card active" data-role="ceo">
            <h3>👔 CEO</h3>
            <p>Strategic insights and growth opportunities</p>
          </div>
          <div class="role-card" data-role="marketer">
            <h3>📢 Marketer</h3>
            <p>Campaign performance and customer insights</p>
          </div>
          <div class="role-card" data-role="product">
            <h3>🚀 Product Manager</h3>
            <p>Feature analysis and user engagement</p>
          </div>
          <div class="role-card" data-role="analyst">
            <h3>📈 Data Analyst</h3>
            <p>Deep statistical analysis and trends</p>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Left Panel - Chat Interface -->
        <section class="left-panel">
          <h2>💬 Chat with AI</h2>
          
          <div class="chat-container" id="chatContainer">
            <div class="message system">
              Welcome! I'm your AI business analyst. Upload data or ask me anything about your business.
            </div>
          </div>
          
          <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            AI is thinking...
          </div>
          
          <div class="input-section">
            <input type="file" id="fileInput" class="file-input" multiple accept=".csv" />
            <button class="file-upload-btn" onclick="document.getElementById('fileInput').click()">
              📎
            </button>
            <input 
              type="text" 
              class="chat-input" 
              id="chatInput" 
              placeholder="Ask about your data or business insights..."
              onkeypress="handleKeyPress(event)"
            />
            <button class="voice-btn" id="voiceBtn">🎤</button>
            <button class="speaker-btn" id="speakerBtn">🔊</button>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
          </div>
        </section>

        <!-- Right Panel - Analytics Dashboard -->
        <section class="right-panel">
          <h2>📊 Analytics Dashboard</h2>
          
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="stat-value" id="recordCount">0</div>
              <div class="stat-label">Records</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="columnCount">0</div>
              <div class="stat-label">Columns</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="fileCount">0</div>
              <div class="stat-label">Files</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="analysisCount">0</div>
              <div class="stat-label">Analyses</div>
            </div>
          </div>
          
          <div class="chart-container">
            <canvas id="dataChart"></canvas>
          </div>
          
          <div class="insights-panel" id="insightsPanel">
            <h3>🎯 Key Insights</h3>
            <div id="insightsList">
              <p>Upload data to see insights here...</p>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Audio Controls -->
    <div class="audio-controls" id="audioControls">
      <button onclick="toggleAudio()">⏸️</button>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <span id="audioTime">0:00</span>
    </div>

    <!-- Status Indicator -->
    <div class="status-indicator" id="statusIndicator">
      Processing...
    </div>

    <script>
      // Global Configuration
      const API_BASE_URL = 'http://localhost:3000/api';
      let currentRole = 'ceo';
      let currentLanguage = 'en';
      let conversationHistory = [];
      let uploadedData = [];
      let currentChart = null;
      let speechSynthesis = window.speechSynthesis;
      let recognition = null;
      let isListening = false;

      // Initialize the application
      document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
        setupEventListeners();
        checkServerConnection();
      });

      async function initializeApp() {
        console.log('🚀 Initializing Narrative AI...');
        
        // Setup speech recognition if available
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'en-US';
          
          recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('chatInput').value = transcript;
            sendMessage();
          };
          
          recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            showStatus('Voice recognition error', 'error');
          };
        } else {
          document.getElementById('voiceBtn').style.display = 'none';
        }
      }

      function setupEventListeners() {
        // Role selection
        document.querySelectorAll('.role-card').forEach(card => {
          card.addEventListener('click', function() {
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            currentRole = this.dataset.role;
            addSystemMessage(`Switched to ${this.querySelector('h3').textContent} perspective`);
          });
        });

        // Language selection
        document.getElementById('languageSelect').addEventListener('change', function() {
          currentLanguage = this.value;
          if (recognition) {
            recognition.lang = this.value === 'en' ? 'en-US' : `${this.value}-${this.value.toUpperCase()}`;
          }
          addSystemMessage(`Language changed to ${this.options[this.selectedIndex].text}`);
        });

        // File upload
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        // Voice controls
        document.getElementById('voiceBtn').addEventListener('click', toggleVoiceRecognition);
        document.getElementById('speakerBtn').addEventListener('click', toggleSpeech);
      }

      async function checkServerConnection() {
        try {
          const response = await fetch(`${API_BASE_URL}/health`);
          const data = await response.json();
          
          if (data.status === 'OK') {
            updateConnectionStatus(true, 'Connected to server');
            if (data.groqConnected) {
              addSystemMessage('🤖 AI engine ready - Groq API connected');
            } else {
              addSystemMessage('⚠️ AI engine not configured - check GROQ_API_KEY');
            }
          }
        } catch (error) {
          updateConnectionStatus(false, 'Server offline');
          addSystemMessage('❌ Cannot connect to server. Please start the backend server.');
          console.error('Connection error:', error);
        }
      }

      function updateConnectionStatus(connected, message) {
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        statusDot.className = connected ? 'status-dot' : 'status-dot offline';
        statusText.textContent = message;
      }

      function handleKeyPress(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }

      async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;

        // Add user message to chat
        addMessage(message, 'user');
        input.value = '';
        
        // Show typing indicator
        showTypingIndicator();
        
        try {
          const response = await fetch(`${API_BASE_URL}/chat`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              message: message,
              role: currentRole,
              language: currentLanguage,
              conversationHistory: conversationHistory.slice(-6),
              hasData: uploadedData.length > 0,
              dataContext: uploadedData.length > 0 ? `${uploadedData.length} records loaded` : ''
            })
          });

          if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
          }

          const data = await response.json();
          
          // Hide typing indicator
          hideTypingIndicator();
          
          // Add AI response to chat
          addMessage(data.response, 'ai');
          
          // Update conversation history
          conversationHistory.push(
            { role: 'user', content: message },
            { role: 'assistant', content: data.response }
          );
          
          // Speak response if speech is enabled
          if (document.getElementById('speakerBtn').classList.contains('active')) {
            speakText(data.response);
          }
          
        } catch (error) {
          hideTypingIndicator();
          addMessage(`Error: ${error.message}`, 'error');
          console.error('Chat error:', error);
        }
      }

      async function handleFileUpload(event) {
        const files = Array.from(event.target.files);
        if (files.length === 0) return;

        showStatus('Uploading files...', 'info');
        
        const formData = new FormData();
        files.forEach(file => formData.append('files', file));

        try {
          const response = await fetch(`${API_BASE_URL}/upload`, {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error(`Upload failed: ${response.status}`);
          }

          const data = await response.json();
          
          let totalRecords = 0;
          let totalColumns = 0;
          let successCount = 0;
          
          data.results.forEach(result => {
            if (result.success) {
              successCount++;
              totalRecords += result.recordCount;
              totalColumns = Math.max(totalColumns, result.columns.length);
              
              // Store data for analysis
              uploadedData = [...uploadedData, ...result.data];
              
              // Display insights
              displayInsights(result.insights);
              
              addSystemMessage(`✅ ${result.filename}: ${result.recordCount} records loaded`);
            } else {
              addMessage(`❌ Error loading ${result.filename}: ${result.error}`, 'error');
            }
          });

          // Update stats
          updateStats(totalRecords, totalColumns, successCount);
          
          // Create visualization
          if (uploadedData.length > 0) {
            createDataVisualization();
          }
          
          showStatus(`Successfully processed ${successCount}/${files.length} files`, 'success');
          
        } catch (error) {
          showStatus('Upload failed', 'error');
          addMessage(`Upload error: ${error.message}`, 'error');
          console.error('Upload error:', error);
        }
        
        // Clear file input
        event.target.value = '';
      }

      function addMessage(content, type) {
        const chatContainer = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = `
          ${content}
          <div class="message-actions">
            <button class="action-btn" onclick="copyMessage(this)" title="Copy">📋</button>
            <button class="action-btn" onclick="speakMessage(this)" title="Speak">🔊</button>
          </div>
        `;
        
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function addSystemMessage(content) {
        addMessage(content, 'system');
      }

      function showTypingIndicator() {
        document.getElementById('typingIndicator').style.display = 'block';
      }

      function hideTypingIndicator() {
        document.getElementById('typingIndicator').style.display = 'none';
      }

      function updateStats(records, columns, files) {
        document.getElementById('recordCount').textContent = records.toLocaleString();
        document.getElementById('columnCount').textContent = columns;
        document.getElementById('fileCount').textContent = files;
        document.getElementById('analysisCount').textContent = conversationHistory.length / 2;
      }

      function displayInsights(insights) {
        const insightsList = document.getElementById('insightsList');
        
        if (insights && insights.length > 0) {
          insightsList.innerHTML = '';
          insights.forEach(insight => {
            const insightDiv = document.createElement('div');
            insightDiv.className = 'insight-card';
            insightDiv.innerHTML = `
              <h4>${insight.title}</h4>
              <p>${insight.content}</p>
            `;
            insightsList.appendChild(insightDiv);
          });
        }
      }

      function createDataVisualization() {
        const canvas = document.getElementById('dataChart');
        const ctx = canvas.getContext('2d');
        
        if (currentChart) {
          currentChart.destroy();
        }

        // Sample visualization - you can customize this based on your data
        if (uploadedData.length > 0) {
          const numericColumns = Object.keys(uploadedData[0]).filter(key => {
            return !isNaN(parseFloat(uploadedData[0][key]));
          });

          if (numericColumns.length > 0) {
            const labels = uploadedData.slice(0, 10).map((_, index) => `Record ${index + 1}`);
            const datasets = numericColumns.slice(0, 3).map((column, index) => ({
              label: column,
              data: uploadedData.slice(0, 10).map(row => parseFloat(row[column]) || 0),
              backgroundColor: `hsla(${index * 120}, 70%, 50%, 0.6)`,
              borderColor: `hsla(${index * 120}, 70%, 50%, 1)`,
              borderWidth: 2
            }));

            currentChart = new Chart(ctx, {
              type: 'line',
              data: { labels, datasets },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  title: {
                    display: true,
                    text: 'Data Overview'
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true
                  }
                }
              }
            });
          }
        }
      }

      function toggleVoiceRecognition() {
        if (!recognition) {
          showStatus('Voice recognition not supported', 'error');
          return;
        }

        const voiceBtn = document.getElementById('voiceBtn');
        
        if (isListening) {
          recognition.stop();
          voiceBtn.textContent = '🎤';
          isListening = false;
          showStatus('Voice recognition stopped', 'info');
        } else {
          recognition.start();
          voiceBtn.textContent = '🛑';
          isListening = true;
          showStatus('Listening... Speak now', 'info');
        }
      }

      function toggleSpeech() {
        const speakerBtn = document.getElementById('speakerBtn');
        speakerBtn.classList.toggle('active');
        
        if (speakerBtn.classList.contains('active')) {
          speakerBtn.style.background = 'var(--primary-gradient)';
          speakerBtn.style.color = 'white';
          showStatus('Text-to-speech enabled', 'info');
        } else {
          speakerBtn.style.background = 'rgba(118, 75, 162, 0.1)';
          speakerBtn.style.color = 'var(--secondary-color)';
          showStatus('Text-to-speech disabled', 'info');
        }
      }

      function speakText(text) {
        if (speechSynthesis && speechSynthesis.speaking) {
          speechSynthesis.cancel();
        }
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = languages[currentLanguage] || 'en-US';
        utterance.rate = 0.9;
        utterance.pitch = 1;
        
        utterance.onstart = () => {
          showAudioControls(true);
        };
        
        utterance.onend = () => {
          showAudioControls(false);
        };
        
        speechSynthesis.speak(utterance);
      }

      function showAudioControls(show) {
        const audioControls = document.getElementById('audioControls');
        audioControls.style.display = show ? 'flex' : 'none';
      }

      function toggleAudio() {
        if (speechSynthesis.speaking) {
          if (speechSynthesis.paused) {
            speechSynthesis.resume();
          } else {
            speechSynthesis.pause();
          }
        }
      }

      function copyMessage(button) {
        const message = button.closest('.message');
        const text = message.textContent.replace(/📋🔊/g, '').trim();
        
        navigator.clipboard.writeText(text).then(() => {
          showStatus('Message copied to clipboard', 'success');
        }).catch(() => {
          showStatus('Failed to copy message', 'error');
        });
      }

      function speakMessage(button) {
        const message = button.closest('.message');
        const text = message.textContent.replace(/📋🔊/g, '').trim();
        speakText(text);
      }

      function showStatus(message, type = 'info') {
        const statusIndicator = document.getElementById('statusIndicator');
        statusIndicator.textContent = message;
        statusIndicator.className = `status-indicator ${type}`;
        statusIndicator.style.display = 'block';
        
        // Auto-hide after 3 seconds
        setTimeout(() => {
          statusIndicator.style.display = 'none';
        }, 3000);
      }

      // Language voice mapping for speech synthesis
      const languages = {
        'en': 'en-US',
        'es': 'es-ES',
        'fr': 'fr-FR',
        'de': 'de-DE',
        'it': 'it-IT',
        'pt': 'pt-BR',
        'ru': 'ru-RU',
        'zh': 'zh-CN',
        'ja': 'ja-JP',
        'ko': 'ko-KR',
        'ar': 'ar-SA',
        'hi': 'hi-IN'
      };

      // Additional utility functions for enhanced functionality
      
      async function analyzeData(analysisType = 'general') {
        if (uploadedData.length === 0) {
          addMessage('No data available for analysis. Please upload a CSV file first.', 'error');
          return;
        }

        showStatus('Analyzing data...', 'info');
        
        try {
          const response = await fetch(`${API_BASE_URL}/analyze`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              data: uploadedData,
              role: currentRole,
              language: currentLanguage,
              analysisType: analysisType
            })
          });

          if (!response.ok) {
            throw new Error(`Analysis failed: ${response.status}`);
          }

          const data = await response.json();
          
          // Add analysis to chat
          addMessage(data.analysis, 'ai');
          
          // Update insights
          displayInsights(data.insights);
          
          // Update stats
          updateStats(data.stats.recordCount, data.stats.columnCount, document.getElementById('fileCount').textContent);
          
          showStatus('Analysis complete', 'success');
          
        } catch (error) {
          showStatus('Analysis failed', 'error');
          addMessage(`Analysis error: ${error.message}`, 'error');
          console.error('Analysis error:', error);
        }
      }

      // Add quick analysis buttons
      function addQuickAnalysisButtons() {
        if (uploadedData.length === 0) return;
        
        const quickActions = document.createElement('div');
        quickActions.className = 'quick-actions';
        quickActions.innerHTML = `
          <div style="display: flex; gap: 10px; margin: 10px 0; flex-wrap: wrap;">
            <button onclick="analyzeData('trends')" class="quick-btn">📈 Analyze Trends</button>
            <button onclick="analyzeData('performance')" class="quick-btn">⚡ Performance Metrics</button>
            <button onclick="analyzeData('insights')" class="quick-btn">💡 Key Insights</button>
            <button onclick="exportAnalysis()" class="quick-btn">📊 Export Analysis</button>
          </div>
        `;
        
        const chatContainer = document.getElementById('chatContainer');
        const existingActions = chatContainer.querySelector('.quick-actions');
        if (existingActions) {
          existingActions.remove();
        }
        chatContainer.appendChild(quickActions);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function exportAnalysis() {
        if (uploadedData.length === 0) {
          addMessage('No data to export', 'error');
          return;
        }

        const analysisData = {
          timestamp: new Date().toISOString(),
          role: currentRole,
          language: currentLanguage,
          dataStats: {
            records: uploadedData.length,
            columns: Object.keys(uploadedData[0] || {}).length
          },
          conversationHistory: conversationHistory,
          insights: Array.from(document.querySelectorAll('.insight-card')).map(card => ({
            title: card.querySelector('h4')?.textContent || '',
            content: card.querySelector('p')?.textContent || ''
          }))
        };

        const blob = new Blob([JSON.stringify(analysisData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `analysis-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showStatus('Analysis exported successfully', 'success');
      }

      // Enhanced file upload with better error handling
      function enhancedFileUpload(files) {
        return new Promise((resolve, reject) => {
          const results = [];
          let processedFiles = 0;
          
          files.forEach((file, index) => {
            Papa.parse(file, {
              header: true,
              skipEmptyLines: true,
              complete: function(result) {
                if (result.errors.length > 0) {
                  results[index] = {
                    filename: file.name,
                    success: false,
                    error: result.errors[0].message
                  };
                } else {
                  results[index] = {
                    filename: file.name,
                    success: true,
                    data: result.data,
                    recordCount: result.data.length,
                    columns: result.meta.fields
                  };
                }
                
                processedFiles++;
                if (processedFiles === files.length) {
                  resolve(results);
                }
              },
              error: function(error) {
                results[index] = {
                  filename: file.name,
                  success: false,
                  error: error.message
                };
                
                processedFiles++;
                if (processedFiles === files.length) {
                  resolve(results);
                }
              }
            });
          });
        });
      }

      // Add CSS for quick action buttons
      const quickActionStyles = `
        .quick-actions {
          background: rgba(255, 255, 255, 0.9);
          border-radius: 15px;
          padding: 15px;
          margin: 15px 0;
          border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .quick-btn {
          background: var(--primary-gradient);
          color: white;
          border: none;
          border-radius: 20px;
          padding: 8px 15px;
          cursor: pointer;
          font-size: 0.9rem;
          transition: var(--transition);
        }
        
        .quick-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .status-indicator.success {
          background: rgba(40, 167, 69, 0.9);
          color: white;
        }
        
        .status-indicator.error {
          background: rgba(220, 53, 69, 0.9);
          color: white;
        }
        
        .status-indicator.info {
          background: rgba(23, 162, 184, 0.9);
          color: white;
        }
      `;

      // Add styles to head
      const styleSheet = document.createElement('style');
      styleSheet.textContent = quickActionStyles;
      document.head.appendChild(styleSheet);

      // Override the original file upload handler to add quick actions
      const originalHandleFileUpload = handleFileUpload;
      handleFileUpload = async function(event) {
        await originalHandleFileUpload(event);
        
        // Add quick analysis buttons after successful upload
        setTimeout(() => {
          addQuickAnalysisButtons();
        }, 1000);
      };

      // Add keyboard shortcuts
      document.addEventListener('keydown', function(event) {
        // Ctrl/Cmd + Enter to send message
        if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
          event.preventDefault();
          sendMessage();
        }
        
        // Escape to stop speech
        if (event.key === 'Escape' && speechSynthesis.speaking) {
          speechSynthesis.cancel();
          showAudioControls(false);
        }
        
        // Ctrl/Cmd + U to upload files
        if ((event.ctrlKey || event.metaKey) && event.key === 'u') {
          event.preventDefault();
          document.getElementById('fileInput').click();
        }
      });

      // Add tooltips and help system
      function initializeHelp() {
        const helpButton = document.createElement('button');
        helpButton.innerHTML = '❓';
        helpButton.className = 'help-btn';
        helpButton.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 20px;
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: var(--primary-gradient);
          color: white;
          border: none;
          cursor: pointer;
          font-size: 1.2rem;
          box-shadow: var(--shadow);
          z-index: 1000;
          transition: var(--transition);
        `;
        
        helpButton.addEventListener('click', showHelp);
        helpButton.addEventListener('mouseenter', function() {
          this.style.transform = 'scale(1.1)';
        });
        helpButton.addEventListener('mouseleave', function() {
          this.style.transform = 'scale(1)';
        });
        
        document.body.appendChild(helpButton);
      }

      function showHelp() {
        const helpContent = `
          <h3>🚀 Narrative AI Help</h3>
          <div style="text-align: left; margin: 15px 0;">
            <h4>Quick Start:</h4>
            <ul>
              <li>📎 Upload CSV files using the paperclip button</li>
              <li>💬 Ask questions about your data</li>
              <li>🎯 Switch between different business roles</li>
              <li>🌐 Change language for multilingual support</li>
            </ul>
            
            <h4>Keyboard Shortcuts:</h4>
            <ul>
              <li><kbd>Ctrl/Cmd + Enter</kbd> - Send message</li>
              <li><kbd>Ctrl/Cmd + U</kbd> - Upload files</li>
              <li><kbd>Escape</kbd> - Stop speech</li>
            </ul>
            
            <h4>Features:</h4>
            <ul>
              <li>🎤 Voice input and 🔊 text-to-speech</li>
              <li>📊 Automatic data visualization</li>
              <li>💡 AI-powered business insights</li>
              <li>📈 Quick analysis buttons</li>
            </ul>
          </div>
        `;
        
        addMessage(helpContent, 'system');
      }

      // Initialize help system
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initializeHelp, 2000);
      });

      // Add auto-save functionality for conversation
      function autoSaveConversation() {
        const conversationData = {
          timestamp: new Date().toISOString(),
          role: currentRole,
          language: currentLanguage,
          history: conversationHistory
        };
        
        try {
          // Use in-memory storage since localStorage is not available
          window.conversationBackup = conversationData;
        } catch (error) {
          console.log('Auto-save not available in this environment');
        }
      }

      // Save conversation every 30 seconds
      setInterval(autoSaveConversation, 30000);

      console.log('🎉 Narrative AI Frontend fully loaded and ready!');
    </script>
  </body>
</html>