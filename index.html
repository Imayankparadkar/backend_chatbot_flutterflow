<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Enhanced Narrative AI Business Analyst</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --glass-bg: rgba(255, 255, 255, 0.95);
        --glass-border: rgba(255, 255, 255, 0.2);
        --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --text-color: #333;
        --border-radius: 20px;
        --transition: all 0.3s ease;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--primary-gradient);
        min-height: 100vh;
        color: var(--text-color);
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
        border: 1px solid var(--glass-border);
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .header h1 {
        font-size: 2.5rem;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .language-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 10px 15px;
        border: 1px solid #e0e0e0;
      }

      .language-selector select {
        border: none;
        background: transparent;
        font-size: 1rem;
        color: var(--text-color);
        outline: none;
        cursor: pointer;
      }

      .role-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }

      .role-card {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid transparent;
        border-radius: 15px;
        padding: 20px;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
      }

      .role-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .role-card.active {
        border-color: var(--primary-color);
        background: var(--primary-gradient);
        color: white;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .left-panel,
      .right-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
        padding: 30px;
        box-shadow: var(--shadow);
        border: 1px solid var(--glass-border);
      }

      .chat-container {
        height: 400px;
        overflow-y: auto;
        border: 1px solid #e0e0e0;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.5);
        scroll-behavior: smooth;
      }

      .message {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 15px;
        max-width: 85%;
        animation: fadeIn 0.3s ease;
        word-wrap: break-word;
        position: relative;
      }

      .message.user {
        background: var(--primary-gradient);
        color: white;
        margin-left: auto;
      }

      .message.ai {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e0e0e0;
      }

      .message.system {
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.3);
        color: #856404;
        text-align: center;
        max-width: 100%;
        margin: 10px 0;
      }

      .message-actions {
        position: absolute;
        top: 5px;
        right: 5px;
        display: none;
        gap: 5px;
      }

      .message:hover .message-actions {
        display: flex;
      }

      .action-btn {
        background: rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 12px;
        transition: var(--transition);
      }

      .action-btn:hover {
        background: rgba(0, 0, 0, 0.2);
        transform: scale(1.1);
      }

      .input-section {
        display: flex;
        gap: 10px;
        align-items: center;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 25px;
        padding: 5px;
        border: 1px solid #e0e0e0;
      }

      .chat-input {
        flex: 1;
        padding: 15px 20px;
        border: none;
        border-radius: 20px;
        font-size: 1rem;
        outline: none;
        background: transparent;
      }

      .file-upload-btn,
      .send-btn,
      .voice-btn,
      .speaker-btn {
        padding: 12px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: var(--transition);
        font-size: 1rem;
        position: relative;
      }

      .file-upload-btn {
        background: rgba(102, 126, 234, 0.1);
        color: var(--primary-color);
      }

      .send-btn {
        background: var(--primary-gradient);
        color: white;
        padding: 12px 16px;
      }

      .voice-btn,
      .speaker-btn {
        background: rgba(118, 75, 162, 0.1);
        color: var(--secondary-color);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .chart-container {
        height: 300px;
        margin-bottom: 20px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1),
          rgba(118, 75, 162, 0.1)
        );
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        transition: var(--transition);
      }

      .stat-card:hover {
        transform: translateY(-3px);
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 5px;
      }

      .insights-panel {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
      }

      .insight-card {
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1),
          rgba(118, 75, 162, 0.1)
        );
        border-left: 4px solid var(--primary-color);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        transition: var(--transition);
      }

      .typing-indicator {
        display: none;
        padding: 15px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #e0e0e0;
        border-radius: 15px;
        max-width: 85%;
        margin-bottom: 15px;
      }

      .typing-dots span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary-color);
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
      }

      .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }

      .audio-controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--glass-bg);
        border-radius: 15px;
        padding: 15px;
        box-shadow: var(--shadow);
        display: none;
        align-items: center;
        gap: 10px;
        z-index: 1000;
      }

      .progress-bar {
        width: 100px;
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--primary-gradient);
        width: 0%;
        transition: width 0.1s ease;
      }

      .status-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--glass-bg);
        border-radius: 10px;
        padding: 10px 15px;
        box-shadow: var(--shadow);
        display: none;
        z-index: 1000;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .recording {
        animation: pulse 1s infinite;
      }

      .speaking {
        color: #28a745 !important;
        animation: pulse 1s infinite;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .role-selector {
          grid-template-columns: 1fr;
        }

        .header-top {
          flex-direction: column;
          align-items: flex-start;
        }

        .input-section {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-top">
          <div>
            <h1>🤖 Enhanced Narrative AI</h1>
            <p>Intelligent business analyst with multilingual support</p>
          </div>
          <div class="language-selector">
            <span>🌍</span>
            <select id="languageSelect" onchange="changeLanguage()">
              <option value="en">English</option>
              <option value="es">Español</option>
              <option value="fr">Français</option>
              <option value="de">Deutsch</option>
              <option value="it">Italiano</option>
              <option value="pt">Português</option>
              <option value="ru">Русский</option>
              <option value="zh">中文</option>
              <option value="ja">日本語</option>
              <option value="ko">한국어</option>
              <option value="ar">العربية</option>
              <option value="hi">हिंदी</option>
            </select>
          </div>
        </div>

        <div class="role-selector">
          <div class="role-card active" onclick="selectRole('ceo')">
            <h3>🎯 CEO</h3>
            <p>Strategic growth insights</p>
          </div>
          <div class="role-card" onclick="selectRole('marketer')">
            <h3>📈 Marketer</h3>
            <p>Campaign performance</p>
          </div>
          <div class="role-card" onclick="selectRole('product')">
            <h3>🛠 Product Lead</h3>
            <p>User engagement</p>
          </div>
          <div class="role-card" onclick="selectRole('analyst')">
            <h3>📊 Analyst</h3>
            <p>Detailed metrics</p>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="left-panel">
          <div class="stats-grid" id="statsGrid" style="display: none"></div>
          <div class="chart-container">
            <canvas id="mainChart"></canvas>
          </div>
          <div class="insights-panel" id="insightsPanel">
            <h4>🔍 Key Insights</h4>
            <div id="insightsList">
              <div class="insight-card">
                <strong>🚀 Getting Started</strong>
                <p>
                  Upload data, ask questions, or explore insights in your
                  preferred language.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="right-panel">
          <h3>💬 Chat with Narrative AI</h3>
          <div class="chat-container" id="chatContainer">
            <div class="message ai">
              <strong>Narrative AI:</strong> Hello! I'm your multilingual
              business analyst. I can help with data analysis, insights, and
              strategy in your preferred language. Upload CSV files or ask
              questions to get started!
              <div class="message-actions">
                <button
                  class="action-btn"
                  onclick="speakMessage(this)"
                  title="Speak"
                >
                  🔊
                </button>
              </div>
            </div>
          </div>

          <div class="typing-indicator" id="typingIndicator">
            <strong>Narrative AI is thinking</strong>
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </div>

          <div class="input-section">
            <button
              class="file-upload-btn"
              onclick="document.getElementById('fileInput').click()"
              title="Upload CSV"
            >
              📎
            </button>
            <input
              type="file"
              id="fileInput"
              style="display: none"
              accept=".csv"
              multiple
            />
            <input
              type="text"
              class="chat-input"
              id="chatInput"
              placeholder="Ask me anything..."
              onkeypress="handleKeyPress(event)"
            />
            <button
              class="voice-btn"
              onclick="toggleVoice()"
              title="Voice input"
              id="voiceBtn"
            >
              🎤
            </button>
            <button
              class="speaker-btn"
              onclick="toggleAutoSpeak()"
              title="Auto-speak responses"
              id="speakerBtn"
            >
              🔊
            </button>
            <button class="send-btn" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>
    </div>

    <div class="audio-controls" id="audioControls">
      <button onclick="stopSpeech()" title="Stop">⏹️</button>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <span id="audioStatus">Speaking...</span>
    </div>

    <div class="status-indicator" id="statusIndicator"></div>

    <script>
      // Configuration
      const GROQ_API_KEY =
        "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";
      const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
      const MODEL = "llama3-8b-8192";

      // State management
      const state = {
        currentRole: "ceo",
        currentLanguage: "en",
        uploadedData: [],
        chart: null,
        isListening: false,
        isSpeaking: false,
        autoSpeak: false,
        conversationHistory: [],
        speechSynthesis: window.speechSynthesis,
        currentUtterance: null,
      };

      // Language configurations
      const languages = {
        en: { name: "English", voice: "en-US" },
        es: { name: "Spanish", voice: "es-ES" },
        fr: { name: "French", voice: "fr-FR" },
        de: { name: "German", voice: "de-DE" },
        it: { name: "Italian", voice: "it-IT" },
        pt: { name: "Portuguese", voice: "pt-BR" },
        ru: { name: "Russian", voice: "ru-RU" },
        zh: { name: "Chinese", voice: "zh-CN" },
        ja: { name: "Japanese", voice: "ja-JP" },
        ko: { name: "Korean", voice: "ko-KR" },
        ar: { name: "Arabic", voice: "ar-SA" },
        hi: { name: "Hindi", voice: "hi-IN" },
      };

      // Initialize application
      document.addEventListener("DOMContentLoaded", init);

      function init() {
        setupEventListeners();
        createDefaultChart();
        showStatus("Ready", 2000);
      }

      function setupEventListeners() {
        document
          .getElementById("fileInput")
          .addEventListener("change", handleFileSelect);

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
          if (e.ctrlKey && e.key === "Enter") sendMessage();
          if (e.key === "Escape") stopSpeech();
        });
      }

      function selectRole(role) {
        state.currentRole = role;
        document
          .querySelectorAll(".role-card")
          .forEach((card) => card.classList.remove("active"));
        event.target.closest(".role-card").classList.add("active");

        const roleNames = {
          ceo: "CEO",
          marketer: "Marketing",
          product: "Product",
          analyst: "Analytics",
        };
        addMessage("system", `Role switched to ${roleNames[role]} perspective`);
      }

      function changeLanguage() {
        const select = document.getElementById("languageSelect");
        state.currentLanguage = select.value;
        showStatus(
          `Language changed to ${languages[state.currentLanguage].name}`,
          2000
        );

        // Update UI text based on language
        updateUILanguage();
      }

      function updateUILanguage() {
        // This would typically involve loading translation files
        // For now, we'll just show a confirmation
        const langName = languages[state.currentLanguage].name;
        addMessage(
          "system",
          `🌍 Language set to ${langName}. AI will respond in ${langName}.`
        );
      }

      async function handleFileSelect(e) {
        const files = Array.from(e.target.files);
        showStatus("Processing files...", 0);

        for (const file of files) {
          if (file.name.endsWith(".csv")) {
            try {
              const data = await parseCSV(file);
              state.uploadedData = state.uploadedData.concat(data);
              addMessage(
                "system",
                `✅ ${file.name} uploaded (${data.length} records)`
              );
            } catch (error) {
              addMessage(
                "system",
                `❌ Error with ${file.name}: ${error.message}`
              );
            }
          }
        }

        if (state.uploadedData.length > 0) {
          analyzeData();
        }

        showStatus("Files processed", 2000);
        e.target.value = "";
      }

      function parseCSV(file) {
        return new Promise((resolve, reject) => {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            complete: (results) => {
              if (results.errors.length > 0) {
                reject(new Error(results.errors[0].message));
              } else {
                resolve(results.data);
              }
            },
          });
        });
      }

      function analyzeData() {
        generateStats();
        createChart();

        const prompt = `Analyze this business data in ${
          languages[state.currentLanguage].name
        }: ${state.uploadedData.length} records with columns: ${Object.keys(
          state.uploadedData[0]
        ).join(", ")}. Provide ${state.currentRole}-focused insights.`;
        sendToGroqAPI(prompt, true);
      }

      function generateStats() {
        const data = state.uploadedData;
        if (data.length === 0) return;

        const numericColumns = Object.keys(data[0]).filter(
          (key) =>
            typeof data[0][key] === "number" || !isNaN(parseFloat(data[0][key]))
        );

        const stats = [
          { label: "Records", value: data.length.toLocaleString() },
          { label: "Columns", value: Object.keys(data[0]).length },
        ];

        // Add relevant business metrics
        if (numericColumns.includes("revenue")) {
          const total = data.reduce(
            (sum, row) => sum + (parseFloat(row.revenue) || 0),
            0
          );
          stats.unshift({
            label: "Revenue",
            value: `$${total.toLocaleString()}`,
          });
        }

        if (numericColumns.includes("users")) {
          const total = data.reduce(
            (sum, row) => sum + (parseFloat(row.users) || 0),
            0
          );
          stats.unshift({ label: "Users", value: total.toLocaleString() });
        }

        document.getElementById("statsGrid").innerHTML = stats
          .map(
            (stat) => `
                <div class="stat-card">
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                </div>
            `
          )
          .join("");

        document.getElementById("statsGrid").style.display = "grid";
      }

      function createChart() {
        const canvas = document.getElementById("mainChart");
        const ctx = canvas.getContext("2d");

        if (state.chart) {
          state.chart.destroy();
        }

        let labels, values;

        if (state.uploadedData.length > 0) {
          const data = state.uploadedData.slice(0, 15);
          labels = data.map(
            (row, i) => row.date || row.product || row.name || `Item ${i + 1}`
          );
          values = data.map(
            (row) =>
              row.revenue ||
              row.users ||
              row.value ||
              row.sales ||
              Math.random() * 100
          );
        } else {
          labels = ["Jan", "Feb", "Mar", "Apr", "May", "Jun"];
          values = [65, 78, 90, 81, 95, 105];
        }

        state.chart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label:
                  state.uploadedData.length > 0
                    ? "Business Data"
                    : "Sample Metrics",
                data: values,
                borderColor: "#667eea",
                backgroundColor: "rgba(102, 126, 234, 0.1)",
                tension: 0.4,
                fill: true,
                pointBackgroundColor: "#667eea",
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
                pointRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: "top" } },
            scales: {
              y: { beginAtZero: true, grid: { color: "rgba(0,0,0,0.1)" } },
              x: { grid: { color: "rgba(0,0,0,0.1)" } },
            },
          },
        });
      }

      function createDefaultChart() {
        createChart();
      }

      async function sendToGroqAPI(message, isDataAnalysis = false) {
        showTyping(true);
        showStatus("Thinking...", 0);

        const systemPrompt = `You are Narrative AI, a multilingual business analyst. Always respond in ${
          languages[state.currentLanguage].name
        } language.

Current context:
- User role: ${state.currentRole.toUpperCase()}
- Language: ${languages[state.currentLanguage].name}
- Data available: ${state.uploadedData.length > 0 ? "Yes" : "No"}

Role focus:
- CEO: Strategic insights, growth, ROI
- Marketer: Campaigns, conversions, traffic
- Product: Features, engagement, usability
- Analyst: Detailed metrics, statistical analysis

Provide clear, actionable insights in the requested language. Be conversational and professional.`;

        const userMessage = { role: "user", content: message };
        state.conversationHistory.push(userMessage);

        try {
          const response = await fetch(GROQ_API_URL, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${GROQ_API_KEY}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: MODEL,
              messages: [
                { role: "system", content: systemPrompt },
                ...state.conversationHistory.slice(-8),
              ],
              max_tokens: 1000,
              temperature: 0.7,
            }),
          });

          if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
          }

          const data = await response.json();
          const aiResponse = data.choices[0].message.content;

          state.conversationHistory.push({
            role: "assistant",
            content: aiResponse,
          });

          showTyping(false);
          addMessage("ai", aiResponse);

          if (state.autoSpeak) {
            speakText(aiResponse);
          }

          if (isDataAnalysis) {
            updateInsights(aiResponse);
          }

          showStatus("Response received", 2000);
        } catch (error) {
          showTyping(false);
          showStatus("Error occurred", 3000);

          let errorMsg = "I apologize, but I'm having connectivity issues. ";
          if (error.message.includes("401"))
            errorMsg += "Authentication problem detected.";
          else if (error.message.includes("429"))
            errorMsg += "Rate limit reached, please wait.";
          else errorMsg += "Please try again in a moment.";

          addMessage("ai", errorMsg);
        }
      }

      function updateInsights(response) {
        const insights = response
          .split(/[.!?]/)
          .filter((s) => s.trim().length > 20)
          .slice(0, 3);

        document.getElementById("insightsList").innerHTML = insights
          .map(
            (insight, i) => `
                <div class="insight-card">
                    <strong>💡 Insight ${i + 1}</strong>
                    <p>${insight.trim()}</p>
                </div>
            `
          )
          .join("");
      }

      function addMessage(sender, message) {
        const chatContainer = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${sender}`;

        let content = "";
        if (sender === "ai") {
          content = `<strong>Narrative AI:</strong> ${message}`;
          content += `<div class="message-actions">
                    <button class="action-btn" onclick="speakMessage(this)" title="Speak">🔊</button>
                </div>`;
        } else if (sender === "system") {
          content = message;
        } else {
          content = message;
        }

        messageDiv.innerHTML = content;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        if (!message) return;

        addMessage("user", message);
        input.value = "";

        sendToGroqAPI(message);
      }

      function speakMessage(button) {
        const messageText = button
          .closest(".message")
          .textContent.replace("Narrative AI:", "")
          .trim();
        speakText(messageText);
      }

      function speakText(text) {
        if (state.isSpeaking) {
          stopSpeech();
        }

        const utterance = new SpeechSynthesisUtterance(text);
        const voices = state.speechSynthesis.getVoices();
        const targetLang = languages[state.currentLanguage].voice;

        const voice =
          voices.find((v) => v.lang.startsWith(targetLang.split("-")[0])) ||
          voices[0];
        if (voice) utterance.voice = voice;

        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        utterance.volume = 0.8;

        utterance.onstart = () => {
          state.isSpeaking = true;
          document.getElementById("speakerBtn").classList.add("speaking");
          showAudioControls(true);
        };

        utterance.onend = () => {
          state.isSpeaking = false;
          document.getElementById("speakerBtn").classList.remove("speaking");
          showAudioControls(false);
        };

        state.currentUtterance = utterance;
        state.speechSynthesis.speak(utterance);
      }

      function stopSpeech() {
        if (state.speechSynthesis.speaking) {
          state.speechSynthesis.cancel();
        }
        state.isSpeaking = false;
        document.getElementById("speakerBtn").classList.remove("speaking");
        showAudioControls(false);
      }

      function toggleAutoSpeak() {
        state.autoSpeak = !state.autoSpeak;
        const btn = document.getElementById("speakerBtn");

        if (state.autoSpeak) {
          btn.style.background = "var(--primary-gradient)";
          btn.style.color = "white";
          showStatus("Auto-speak enabled", 2000);
        } else {
          btn.style.background = "rgba(118, 75, 162, 0.1)";
          btn.style.color = "var(--secondary-color)";
          showStatus("Auto-speak disabled", 2000);
        }
      }

      function toggleVoice() {
        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          showStatus("Speech recognition not supported", 3000);
          return;
        }

        if (state.isListening) {
          stopListening();
        } else {
          startListening();
        }
      }

      function startListening() {
        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = languages[state.currentLanguage].voice;

        recognition.onstart = () => {
          state.isListening = true;
          document.getElementById("voiceBtn").classList.add("recording");
          showStatus("Listening...", 0);
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          document.getElementById("chatInput").value = transcript;
          showStatus("Voice input captured", 2000);
        };

        recognition.onerror = () => {
          showStatus("Voice recognition error", 3000);
          stopListening();
        };

        recognition.onend = () => {
          stopListening();
        };

        recognition.start();
      }

      function stopListening() {
        state.isListening = false;
        document.getElementById("voiceBtn").classList.remove("recording");
        showStatus("Listening stopped", 2000);
      }

      function handleKeyPress(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }

      function showTyping(show) {
        const indicator = document.getElementById("typingIndicator");
        indicator.style.display = show ? "block" : "none";

        if (show) {
          const chatContainer = document.getElementById("chatContainer");
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      }

      function showAudioControls(show) {
        const controls = document.getElementById("audioControls");
        controls.style.display = show ? "flex" : "none";
      }

      function showStatus(message, duration) {
        const indicator = document.getElementById("statusIndicator");
        indicator.textContent = message;
        indicator.style.display = "block";

        if (duration > 0) {
          setTimeout(() => {
            indicator.style.display = "none";
          }, duration);
        }
      }

      // Export functions for file upload handling
      function exportData() {
        if (state.uploadedData.length === 0) {
          showStatus("No data to export", 2000);
          return;
        }

        const csv = Papa.unparse(state.uploadedData);
        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "analyzed_data.csv";
        a.click();
        window.URL.revokeObjectURL(url);

        showStatus("Data exported", 2000);
      }

      // Utility functions
      function formatNumber(num) {
        if (num >= 1000000) return (num / 1000000).toFixed(1) + "M";
        if (num >= 1000) return (num / 1000).toFixed(1) + "K";
        return num.toString();
      }

      function getRandomColor() {
        const colors = [
          "#667eea",
          "#764ba2",
          "#f093fb",
          "#f5576c",
          "#4facfe",
          "#00f2fe",
        ];
        return colors[Math.floor(Math.random() * colors.length)];
      }
    </script>
  </body>
</html>
